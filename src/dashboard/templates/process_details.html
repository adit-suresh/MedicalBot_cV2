{% extends 'base.html' %}

{% block title %}Process Details - {{ app_name }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="h3 mb-0 text-gray-800">Process Details</h1>
        <p class="text-muted">Viewing details for process {{ process.process_id }}</p>
    </div>
    <div class="col-md-4 text-end">
        <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
        </a>
    </div>
</div>

<!-- Process Status Card -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card shadow">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5 class="card-title">{{ process.client_name }}</h5>
                        <h6 class="card-subtitle mb-2 text-muted">{{ process.email_subject }}</h6>
                        <p class="card-text"><small>Created: {{ process.created_at|replace('T', ' ') }}</small></p>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="mb-2">
                            <span class="badge rounded-pill 
                                {% if process.status == 'COMPLETED' %}bg-success{% 
                                elif process.status == 'PROCESSING' %}bg-primary{% 
                                elif process.status == 'ERROR' %}bg-danger{% 
                                elif process.status == 'MANUAL_REVIEW' %}bg-warning{% 
                                elif process.status == 'PAUSED' %}bg-secondary{% 
                                elif process.status == 'CANCELLED' %}bg-dark{% 
                                else %}bg-info{% endif %} p-2">
                                {{ process.status }}
                            </span>
                        </div>
                        <div>
                            <small class="text-muted">Current Stage: {{ process.current_stage }}</small>
                        </div>
                    </div>
                    <div class="col-md-3 text-end">
                        {% if process.status in ['PAUSED', 'ERROR', 'MANUAL_REVIEW'] %}
                        <button type="button" class="btn btn-success mb-2" data-bs-toggle="modal" data-bs-target="#resumeProcessModal">
                            <i class="fas fa-play me-1"></i> Resume Process
                        </button>
                        {% endif %}
                        
                        {% if process.status not in ['COMPLETED', 'CANCELLED', 'FAILED'] %}
                        <button type="button" class="btn btn-danger mb-2" data-bs-toggle="modal" data-bs-target="#cancelProcessModal">
                            <i class="fas fa-times me-1"></i> Cancel Process
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Content Tabs -->
<div class="row">
    <div class="col-lg-12">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <ul class="nav nav-tabs card-header-tabs" id="processDetailsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" 
                                type="button" role="tab" aria-controls="details" aria-selected="true">
                            Details
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="documents-tab" data-bs-toggle="tab" data-bs-target="#documents" 
                                type="button" role="tab" aria-controls="documents" aria-selected="false">
                            Documents ({{ documents|length }})
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="outputs-tab" data-bs-toggle="tab" data-bs-target="#outputs" 
                                type="button" role="tab" aria-controls="outputs" aria-selected="false">
                            Outputs ({{ outputs|length }})
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="timeline-tab" data-bs-toggle="tab" data-bs-target="#timeline" 
                                type="button" role="tab" aria-controls="timeline" aria-selected="false">
                            Timeline
                        </button>
                    </li>
                    {% if process.errors %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="errors-tab" data-bs-toggle="tab" data-bs-target="#errors" 
                                type="button" role="tab" aria-controls="errors" aria-selected="false">
                            Errors <span class="badge rounded-pill bg-danger">{{ process.errors|length }}</span>
                        </button>
                    </li>
                    {% endif %}
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="processDetailsTabContent">
                    <!-- Details Tab -->
                    <div class="tab-pane fade show active" id="details" role="tabpanel" aria-labelledby="details-tab">
                        <div class="row">
                            <div class="col-md-6">
                                <h5>Process Information</h5>
                                <table class="table table-bordered">
                                    <tbody>
                                        <tr>
                                            <th style="width: 30%">Process ID</th>
                                            <td>{{ process.process_id }}</td>
                                        </tr>
                                        <tr>
                                            <th>Client</th>
                                            <td>{{ process.client_name }}</td>
                                        </tr>
                                        <tr>
                                            <th>Status</th>
                                            <td>
                                                <span class="badge rounded-pill 
                                                    {% if process.status == 'COMPLETED' %}bg-success{% 
                                                    elif process.status == 'PROCESSING' %}bg-primary{% 
                                                    elif process.status == 'ERROR' %}bg-danger{% 
                                                    elif process.status == 'MANUAL_REVIEW' %}bg-warning{% 
                                                    elif process.status == 'PAUSED' %}bg-secondary{% 
                                                    elif process.status == 'CANCELLED' %}bg-dark{% 
                                                    else %}bg-info{% endif %}">
                                                    {{ process.status }}
                                                </span>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>Created</th>
                                            <td>{{ process.created_at|replace('T', ' ') }}</td>
                                        </tr>
                                        <tr>
                                            <th>Last Updated</th>
                                            <td>{{ process.last_updated|replace('T', ' ') }}</td>
                                        </tr>
                                        <tr>
                                            <th>Processing Time</th>
                                            <td>
                                                {% if process.status == 'COMPLETED' %}
                                                    {{ ((process.completed_at|string|replace('T', ' ')|datetime - process.created_at|string|replace('T', ' ')|datetime).total_seconds() / 60)|round(1) }} minutes
                                                {% else %}
                                                    In progress
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>Priority</th>
                                            <td>
                                                {% for i in range(5) %}
                                                    {% if i < process.priority|default(3) %}
                                                        <i class="fas fa-star text-warning"></i>
                                                    {% else %}
                                                        <i class="far fa-star text-muted"></i>
                                                    {% endif %}
                                                {% endfor %}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h5>Email Information</h5>
                                <table class="table table-bordered">
                                    <tbody>
                                        <tr>
                                            <th style="width: 30%">From</th>
                                            <td>{{ process.email_from }}</td>
                                        </tr>
                                        <tr>
                                            <th>Subject</th>
                                            <td>{{ process.email_subject }}</td>
                                        </tr>
                                        <tr>
                                            <th>Received</th>
                                            <td>{{ process.email_received_at|replace('T', ' ') }}</td>
                                        </tr>
                                        <tr>
                                            <th>Has Attachments</th>
                                            <td>{{ 'Yes' if process.email_has_attachments else 'No' }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                                
                                <h5 class="mt-4">Notes</h5>
                                <div class="card">
                                    <div class="card-body bg-light">
                                        {% if process.notes %}
                                            <p class="card-text">{{ process.notes }}</p>
                                        {% else %}
                                            <p class="text-muted">No notes available</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Documents Tab -->
                    <div class="tab-pane fade" id="documents" role="tabpanel" aria-labelledby="documents-tab">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover" id="documentsTable">
                                <thead>
                                    <tr>
                                        <th>Filename</th>
                                        <th>Type</th>
                                        <th>Size</th>
                                        <th>Upload Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for doc in documents %}
                                    <tr>
                                        <td>{{ doc.filename }}</td>
                                        <td>
                                            {% if doc.file_type == 'excel' %}
                                                <i class="fas fa-file-excel text-success me-1"></i> Excel
                                            {% elif doc.file_type == 'image' %}
                                                <i class="fas fa-file-image text-primary me-1"></i> Image
                                            {% elif doc.file_type == 'pdf' %}
                                                <i class="fas fa-file-pdf text-danger me-1"></i> PDF
                                            {% else %}
                                                <i class="fas fa-file text-secondary me-1"></i> {{ doc.file_type|capitalize }}
                                            {% endif %}
                                        </td>
                                        <td>{{ doc.file_size_readable }}</td>
                                        <td>{{ doc.uploaded_at|replace('T', ' ')|truncate(16, true, '') }}</td>
                                        <td>
                                            <a href="{{ url_for('main.download_file', file_id=doc.file_id) }}" 
                                               class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-download me-1"></i> Download
                                            </a>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center py-3">No documents available</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Outputs Tab -->
                    <div class="tab-pane fade" id="outputs" role="tabpanel" aria-labelledby="outputs-tab">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover" id="outputsTable">
                                <thead>
                                    <tr>
                                        <th>Filename</th>
                                        <th>Type</th>
                                        <th>Size</th>
                                        <th>Generated Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for output in outputs %}
                                    <tr>
                                        <td>{{ output.filename }}</td>
                                        <td>
                                            {% if output.file_type == 'excel' %}
                                                <i class="fas fa-file-excel text-success me-1"></i> Excel
                                            {% elif output.file_type == 'image' %}
                                                <i class="fas fa-file-image text-primary me-1"></i> Image
                                            {% elif output.file_type == 'pdf' %}
                                                <i class="fas fa-file-pdf text-danger me-1"></i> PDF
                                            {% else %}
                                                <i class="fas fa-file text-secondary me-1"></i> {{ output.file_type|capitalize }}
                                            {% endif %}
                                        </td>
                                        <td>{{ output.file_size_readable }}</td>
                                        <td>{{ output.generated_at|replace('T', ' ')|truncate(16, true, '') }}</td>
                                        <td>
                                            <a href="{{ url_for('main.download_file', file_id=output.file_id) }}" 
                                               class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-download me-1"></i> Download
                                            </a>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center py-3">No output files available</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Timeline Tab -->
                    <div class="tab-pane fade" id="timeline" role="tabpanel" aria-labelledby="timeline-tab">
                        <div class="timeline-container">
                            {% for event in timeline %}
                            <div class="timeline-item">
                                <div class="timeline-marker
                                    {% if event.event_type == 'process_created' %}bg-primary{% 
                                    elif event.event_type == 'process_completed' %}bg-success{% 
                                    elif event.event_type == 'process_error' %}bg-danger{% 
                                    elif event.event_type == 'process_resumed' %}bg-info{% 
                                    elif event.event_type == 'process_cancelled' %}bg-dark{% 
                                    else %}bg-secondary{% endif %}">
                                    {% if event.event_type == 'process_created' %}
                                        <i class="fas fa-play"></i>
                                    {% elif event.event_type == 'process_completed' %}
                                        <i class="fas fa-check"></i>
                                    {% elif event.event_type == 'process_error' %}
                                        <i class="fas fa-exclamation"></i>
                                    {% elif event.event_type == 'process_resumed' %}
                                        <i class="fas fa-redo"></i>
                                    {% elif event.event_type == 'process_cancelled' %}
                                        <i class="fas fa-times"></i>
                                    {% elif event.event_type == 'status_change' %}
                                        <i class="fas fa-exchange-alt"></i>
                                    {% elif event.event_type == 'stage_change' %}
                                        <i class="fas fa-arrow-right"></i>
                                    {% elif event.event_type == 'note_added' %}
                                        <i class="fas fa-sticky-note"></i>
                                    {% else %}
                                        <i class="fas fa-circle"></i>
                                    {% endif %}
                                </div>
                                <div class="timeline-content">
                                    <div class="timeline-header">
                                        <span class="timeline-title">
                                            {% if event.event_type == 'process_created' %}
                                                Process Created
                                            {% elif event.event_type == 'process_completed' %}
                                                Process Completed
                                            {% elif event.event_type == 'process_error' %}
                                                Error Occurred
                                            {% elif event.event_type == 'process_resumed' %}
                                                Process Resumed
                                            {% elif event.event_type == 'process_cancelled' %}
                                                Process Cancelled
                                            {% elif event.event_type == 'status_change' %}
                                                Status Changed
                                            {% elif event.event_type == 'stage_change' %}
                                                Stage Changed
                                            {% elif event.event_type == 'note_added' %}
                                                Note Added
                                            {% else %}
                                                {{ event.event_type|replace('_', ' ')|capitalize }}
                                            {% endif %}
                                        </span>
                                        <span class="timeline-date">{{ event.timestamp|replace('T', ' ') }}</span>
                                    </div>
                                    <div class="timeline-body">
                                        {% if event.event_type == 'status_change' %}
                                            Status changed from <strong>{{ event.details.previous_status }}</strong> to <strong>{{ event.details.new_status }}</strong>
                                        {% elif event.event_type == 'stage_change' %}
                                            Processing moved from <strong>{{ event.details.previous_stage }}</strong> to <strong>{{ event.details.new_stage }}</strong>
                                        {% elif event.event_type == 'process_error' %}
                                            <div class="alert alert-danger">
                                                {{ event.details.error_message }}
                                            </div>
                                            <small>Error occurred in stage: <strong>{{ event.details.stage }}</strong></small>
                                        {% elif event.event_type == 'note_added' %}
                                            <div class="card">
                                                <div class="card-body bg-light py-2">
                                                    {{ event.details.note }}
                                                </div>
                                            </div>
                                            <small>Added by: {{ event.user_id }}</small>
                                        {% elif event.event_type == 'process_resumed' %}
                                            <p>Process resumed from status: <strong>{{ event.details.previous_status }}</strong></p>
                                            {% if event.details.notes %}
                                                <small>Note: {{ event.details.notes }}</small>
                                            {% endif %}
                                        {% elif event.event_type == 'process_cancelled' %}
                                            <p>Process cancelled from status: <strong>{{ event.details.previous_status }}</strong></p>
                                            <small>Reason: {{ event.details.reason }}</small>
                                        {% elif event.details %}
                                            <pre class="timeline-details">{{ event.details|tojson(indent=2) }}</pre>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <p class="text-muted">No timeline events available</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Errors Tab -->
                    {% if process.errors %}
                    <div class="tab-pane fade" id="errors" role="tabpanel" aria-labelledby="errors-tab">
                        <div class="list-group">
                            {% for error in process.errors %}
                            <div class="list-group-item list-group-item-danger">
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">{{ error.error_type }}</h5>
                                    <small>{{ error.timestamp|replace('T', ' ') }}</small>
                                </div>
                                <p class="mb-1">{{ error.error_message }}</p>
                                <small>
                                    Stage: <strong>{{ error.process_stage }}</strong> |
                                    Error ID: {{ error.error_id }}
                                </small>
                                {% if error.stack_trace %}
                                <button class="btn btn-sm btn-outline-secondary mt-2" type="button" 
                                        data-bs-toggle="collapse" data-bs-target="#error{{ loop.index }}">
                                    Show Stack Trace
                                </button>
                                <div class="collapse mt-2" id="error{{ loop.index }}">
                                    <div class="card card-body">
                                        <pre class="mb-0"><code>{{ error.stack_trace }}</code></pre>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Resume Process Modal -->
<div class="modal fade" id="resumeProcessModal" tabindex="-1" aria-labelledby="resumeProcessModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resumeProcessModalLabel">Resume Process</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('main.resume_process', process_id=process.process_id) }}" method="post">
                <div class="modal-body">
                    <p>Are you sure you want to resume this process?</p>
                    <div class="mb-3">
                        <label for="resumeNotes" class="form-label">Notes (optional)</label>
                        <textarea class="form-control" id="resumeNotes" name="notes" rows="3" 
                                 placeholder="Enter any notes about resuming this process"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">Resume Process</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Cancel Process Modal -->
<div class="modal fade" id="cancelProcessModal" tabindex="-1" aria-labelledby="cancelProcessModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelProcessModalLabel">Cancel Process</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('main.cancel_process', process_id=process.process_id) }}" method="post">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> This action cannot be undone.
                    </div>
                    <div class="mb-3">
                        <label for="cancelReason" class="form-label">Reason for cancellation <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="cancelReason" name="reason" rows="3" required
                                 placeholder="Please provide a reason for cancelling this process"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-danger">Cancel Process</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/process-details.js') }}"></script>
<script>
    $(document).ready(function() {
        // Initialize DataTables
        $('#documentsTable').DataTable({
            order: [[3, 'desc']], // Sort by upload date descending
            pageLength: 5,
            lengthMenu: [5, 10, 25, 50]
        });
        
        $('#outputsTable').DataTable({
            order: [[3, 'desc']], // Sort by generated date descending
            pageLength: 5,
            lengthMenu: [5, 10, 25, 50]
        });
        
        // Activate tab from URL hash if present
        let hash = window.location.hash;
        if (hash) {
            $('.nav-tabs a[href="' + hash + '"]').tab('show');
        }
        
        // Update URL hash when tab changes
        $('a[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
            window.location.hash = e.target.getAttribute('data-bs-target');
        });
    });
</script>
{% endblock %}

{% block extra_css %}
<style>
    /* Timeline Styles */
    .timeline-container {
        position: relative;
        padding: 1rem;
        margin: 0 auto;
    }
    
    .timeline-container::before {
        content: '';
        position: absolute;
        height: 100%;
        border: 1px solid #dee2e6;
        left: 1rem;
        top: 0;
    }
    
    .timeline-item {
        position: relative;
        margin-bottom: 1.5rem;
        display: flex;
    }
    
    .timeline-marker {
        position: relative;
        width: 2rem;
        height: 2rem;
        background-color: #6c757d;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        z-index: 1;
    }
    
    .timeline-content {
        flex: 1;
        margin-left: 1rem;
        padding: 0.5rem 1rem;
        background-color: #f8f9fa;
        border-radius: 0.25rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .timeline-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .timeline-title {
        font-weight: bold;
    }
    
    .timeline-date {
        font-size: 0.875rem;
        color: #6c757d;
    }
    
    .timeline-body {
        font-size: 0.9rem;
    }
    
    .timeline-details {
        font-size: 0.8rem;
        background-color: #f1f1f1;
        padding: 0.5rem;
        border-radius: 0.25rem;
        max-height: 150px;
        overflow-y: auto;
    }
</style>
{% endblock %}